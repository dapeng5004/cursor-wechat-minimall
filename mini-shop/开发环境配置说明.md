# 微信小程序开发环境配置说明

## 图片加载问题解决方案

### 问题描述
在微信小程序开发过程中，图片加载失败，出现以下错误：
- `net::ERR_CERT_AUTHORITY_INVALID` - SSL证书无效
- `net::ERR_BLOCKED_BY_RESPONSE` - 网络请求被阻止

### 解决方案

#### 1. 微信开发者工具配置
在微信开发者工具中，需要开启以下设置：

1. **项目设置** → **本地设置**
   - ✅ 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
   - ✅ 不校验安全域名、TLS 版本以及 HTTPS 证书

2. **详情** → **本地设置**
   - ✅ 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书

#### 2. 后端服务器配置

##### 开发环境（推荐使用HTTP）
项目已配置为自动根据环境选择HTTP或HTTPS：

```bash
# 启动开发服务器
cd mini-server
./start-dev.sh
```

或者手动启动：
```bash
cd mini-server
NODE_ENV=development node app.js
```

服务器会自动使用HTTP协议，访问地址：`http://localhost:3002`

##### 生产环境（使用HTTPS）
```javascript
// 生产环境使用HTTPS协议
const https = require('https');
const fs = require('fs');

const options = {
  key: fs.readFileSync('path/to/private.key'),
  cert: fs.readFileSync('path/to/certificate.crt')
};

https.createServer(options, app).listen(3002, () => {
  console.log('HTTPS服务器运行在端口 3002');
});
```

#### 3. 环境配置说明

项目已配置了环境自动识别：

- **开发环境**：自动使用 `http://127.0.0.1:3002`
- **体验版**：使用 `https://your-domain.com`
- **正式版**：使用 `https://your-domain.com`

#### 4. 图片加载优化

1. **使用安全图片组件**
   - 自动处理加载失败
   - 显示默认图片
   - 提供加载状态

2. **图片压缩优化**
   - 建议图片大小不超过 2MB
   - 使用 WebP 格式
   - 合理设置图片尺寸

#### 5. 常见问题排查

1. **图片仍然加载失败**
   - 检查后端服务器是否正常运行
   - 确认图片文件是否存在
   - 检查网络连接

2. **HTTPS证书问题**
   - 开发环境建议使用HTTP
   - 生产环境需要配置有效的SSL证书

3. **跨域问题**
   - 确保后端配置了正确的CORS头
   - 检查域名白名单配置

### 使用示例

```javascript
// 在页面中使用安全图片组件
<safe-image 
  src="{{imageUrl}}" 
  mode="aspectFill" 
  default-src="/images/default/goods.png"
  bindload="onImageLoad"
  binderror="onImageError"
/>
```

### 注意事项

1. 开发时请确保后端服务器正常运行
2. 生产环境必须使用HTTPS协议
3. 图片资源建议使用CDN加速
4. 定期检查图片资源是否有效 